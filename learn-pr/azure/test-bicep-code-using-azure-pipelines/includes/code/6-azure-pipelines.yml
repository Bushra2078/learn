trigger:
  branches:
    include:
    - main

pool:
  vmImage: ubuntu-latest

stages:
- stage: Validate
  jobs: 
  - job: Validate
    steps:
      - script: |
          bicep build deploy/main.bicep
        displayName: Transpile and run checks

- stage: PreFlight
  jobs: 
  - job: PreFlight
    steps:
      - task: AzureCLI@2
        displayName: Run pre-flight checks
        inputs:
          azureSubscription: $(serviceConnectionReadOnly)
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: 'az deployment group validate --resource-group $(resourcegroup) --template-file deploy/main.bicep -p environmentType=$(environment)'

- stage: WhatIf
  jobs: 
  - job: WhatIf
    steps:
      - task: AzureCLI@2
        displayName: Run what-if checks
        inputs:
          azureSubscription: $(serviceConnectionReadOnly)
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: 'az deployment group what-if --resource-group $(resourcegroup) --template-file deploy/main.bicep -p environmentType=$(environment)'

- stage: Deploy
  jobs:
  - job: Deploy
    steps:
    - task: AzureCLI@2
      displayName: Deploy
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: 'az deployment group create --resource-group $(resourcegroup) --template-file deploy/main.bicep -n $(Build.BuildId) -p environmentType=$(environment)'