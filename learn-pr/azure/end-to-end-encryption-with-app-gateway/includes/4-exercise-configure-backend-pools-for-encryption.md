Configuring TLS transport encryption is an important step to ensure your application is secure.

You want to implement end-to-end encryption for the shipping portal application. Encryption will ensure all data transmitted between your users and your server is encrypted, and that no unauthorized user can intercept and read the data.

In this unit, you'll set up the web application and Application Gateway. Next you'll create some self-signed TLS certificates and enable encryption in your backend pool to secure the traffic from the Application Gateway to your servers.

## Setup

[!include[](../../../includes/azure-sandbox-activate.md)]

1. In the Cloud Shell window on the right, run the following command to download the source code for the shipping portal:

    <!-- IMPORTANT - FOR REVIEWER. CHANGE THE NAME OF THE REPO BELOW AS APPROPRIATE.
    ALSO, THE SCRIPT, server-config/setup-vm.sh REFERENCES THIS REPO. CHANGE THE "GIT CLONE" STATEMENT IN THIS SCRIPT AS WELL BEFORE UPLOADING TO THE FINAL GITHUB DESTINATION -->

    ```bash
    git clone http://github.com/<location of repository>/shippingportal shippingportal
    ```

1. Move to the ShippingPortal folder:

    ```bash
    cd shippingportal
    ```

1. Run the following commands to create a variable named *rgName* that references the sandobox resource group, and execute the setup script to create the virtual machine and Application Gateway

    ```bash
    export rgName=<rgn>[Sandbox resource group]</rgn>
    bash setup-infra.sh
    ```

## Configure backend pools for encryption

1. Get the private IP address of the virtual machine:

    ```bash
    privateip="$(az vm list-ip-addresses \
      --resource-group $rgName \
      --name webservervm1 \
      --query "[0].virtualMachine.network.privateIpAddresses[0]" \
      --output tsv)"
    ```

1. Verify that the gateway has been created. Repeat this command every 30 seconds until the name of the gateway is displayed

    ```azurecli
    az network application-gateway list
    ```

1. Setup the backend pool for Application Gateway using the private IP address of the virtual machine:

    ```azurecli
    az network application-gateway address-pool create \
      --resource-group $rgName \
      --gateway-name gw-shipping \
      --name ap-backend \
      --servers $privateip
    ```

1. Upload the SSL certificate for Application Gateway. The certificate was generated by the setup script, and is stored in the *shipping-ssl.pfx* file in the *server-config* folder:

    ```azurecli
     az network application-gateway ssl-cert create \
       --resource-group $rgName \
       --gateway-name gw-shipping \
       --name shipping-ssl-cert \
       --cert-file server-config/shipping-ssl.pfx \
       --cert-password somepassword
    ```

1. Upload the authorization certificate

    ```azurecli
    az network application-gateway auth-cert create \
      --resource-group $rgName \
      --gateway-name gw-shipping \
      --name shipping-auth-cert \
      --cert-file server-config/shipping-ssl.crt
    ```

1. Configure the HTTP settings to use the certificate

    ```bash
    az network application-gateway http-settings create \
      --resource-group $rgName \
      --gateway-name gw-shipping \
      --name https-settings \
      --port 443 \
      --protocol Https \
      --auth-certs shipping-auth-cert
    ```