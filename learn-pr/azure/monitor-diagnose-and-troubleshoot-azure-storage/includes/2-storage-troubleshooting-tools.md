Diagnosing and troubleshooting issues for an application hosted in a cloud environment can be more complex than in traditional environments. To support these types of applications successfully, you should monitor them and understand how to diagnose and troubleshoot any aspects of them and their dependent technologies.A combination of tools and logging can be used to identify issues. 

The new Automobile Distribution customer portal uses Azure Storage to store uploaded files. As there are some concerns about the performance of storing files in the portal, the first step to diagnosing any issues is knowing which troubleshooting tools are available.

In this unit, you'll learn about some of the different tools you can use to analyze issues with Azure Storage.

## Tools available for troubleshooting Azure Storage

Troubleshooting issues with apps deployed to Azure or using Azure storage is an important skill. Any problems can be complicated due to the distributed nature of these apps. There are several tools and utilities that provide useful features for monitoring Azure storage. You can use the information generated by these tools to help pinpoint any performance issues that might occur. These tools show different facets and insights into Azure Storage. You would typically use these tools in combination with each other. Additional tools are available from third-party sources, but aren't discussed in this module.

### Azure Storage Analytics

Azure Storage Analytics provides metrics and logging information for apps and services accessing Azure Storage. Enable it for each service using the storage accounts that you wish to monitor. The information gathered includes:

- *Storage metrics*. These metrics track storage transactions and capacity. You use these metrics to monitor the operations being performed against your Storage accounts. The transaction metrics record the requests and responses made to and from storage. The capacity metrics show how much storage space is used, and the number containers and objects held in storage. Azure records storage metrics in a series of  tables in your storage account. These tables are given names that begin with the **\$Metrics** prefix.

    > [!NOTE]
    > Capacity metrics are currently available for Blob storage only.

- *Storage logging*. Logging records detailed information about all requests made to the Storage service, including failed, successful, and timed out requests. Storage logging also tracks the latency of operations, which is useful for detecting performance problems. This information is recorded in a set of blobs in a container named **\$logs** in the storage account.

You'll learn more about using Azure Storage Analytics in the next unit.

### Azure portal

The Azure portal gives you a graphical way to view and monitor storage performance in near real time (there may be a delay of a few minutes between data being captured and being displayed by the Azure portal). In the Azure portal, you can:

- Configure metrics and logging.
- View graphs and charts, and select which metrics to visualize.
- Assess how your applications are performing over time.
- Configure alerts to notify you of any behavior that is out of the ordinary.

You monitor the performance of a storage account using the **Metrics (classic)** tab on the page for the storage account in the Azure portal. The image below shows an example, displaying the ingress and egress rates, end-to-end latency, and success rate for requests sent to blob storage in a storage account:

![Screenshot of the Metrics page for a storage account in the Azure portal](../media/2-block-blob-metrics.png)

### AzCopy

You can download the storage account logs to your local computer by using the [AzCopy](https://aka.ms/AzCopy) utility, or the desktop version of [Azure Storage Explorer](https://azure.microsoft.com/features/storage-explorer/). You can then analyze this data by using analysis tools on your desktop.

The following command shows an example that retrieves the diagnostic logs for a storage account named *mystorageaccount*. The log files are saved to a folder named *C:\logs* on the local computer. Replace **\<storage account key\>** with the one of the keys that you can find on the **Access keys** page for the storage account in the Azure portal:

```bash
azcopy /source:"https://mystorageaccount.blob.core.windows.net/$logs" /dest:C:logs /sourceType:blob /SourceKey:<storage account key> /S
```

> [!NOTE]
> The **\$logs** container is hidden from many Azure tools. For example, you won't see it appear in the online version of Storage Explorer used by the Azure portal, or Cloud Explorer in Visual Studio. AzCopy and the desktop version of Azure Storage Explorer are exceptions.

You can't use AzCopy to download data from storage tables, so you can't use this tool to retrieve the data from the **\$Metrics** tables.

### Azure Storage Explorer (desktop version)

The desktop version of [Azure Storage Explorer](https://azure.microsoft.com/features/storage-explorer/) gives you another way to view the logs and metrics gathered by Azure Storage Analytics. The **\$Metrics** tables and the **$logs** container are all accessible in Storage Explorer, and you can export the data, including the metrics in the **\$Metrics** tables, to a folder on your desktop computer.

### Microsoft Message Analyzer

Microsoft Message Analyzer is a protocol analyzer for capturing, displaying, and analyzing messaging traffic, events, and other system or application messages. Message Analyzer also enables you to load, aggregate, and analyze data from logs and saved trace files.

You can use Message Analyzer to examine many types of log files, including:

- Server logs, created when you enable logging in Azure. These logs include those generated by Azure Storage Analyzer.
- .NET client logs, created when client-side logging is enabled for a .NET Core application.
- HTTP network trace log, created by a web server.

Use Message Analyzer for reading log files. It displays log data in visual format. It allows searching, grouping, and filtering, enabling you to easily examine errors and locate the source of performance issues.

The image below shows Message Analyzer displaying diagnostic log information for a storage account. The log information was downloaded from Azure storage using the AzCopy command shown previously:

![Screenshot of the Metrics page for a storage account in the Azure portal](../media/2-message-analyzer.png)

You can download Message Analyzer from the [Message Analyzer page](https://www.microsoft.com/download/details.aspx?id=44226) on the Microsoft website.

Unit 7 describes using Message Analyzer in more detail.
