You've decided that the issues that the new Customer Portal is experiencing could be something to do with the way files are stored or uploaded. You want to determine why the problem occurs by capturing the metrics for blob storage. You can use these metrics to find out how many errors occur, and whether the errors are associated with a particular time of day (possible peak periods), or some other factor.

> [!IMPORTANT]
> This exercise is in two parts. You can only perform the second part after waiting for several minutes. This is due to the way in which Azure Storage Analytics process the operations that it monitors to generate its aggregated results. You may wish to leave the exercise after part 1, and come back to it once the metrics have been generated.

In part 1 of this exercise, you'll use Azure portal, and PowerShell, to configure storage metrics for your storage account. You'll then run an application that simulates uploading and downloading a number of files to and from blob storage in your account.

In part 2, you'll examine the metrics generated by the application.

## *Part 1*

## Setup

[!include[](../../../includes/azure-sandbox-activate.md)]

1. In the Azure portal, click **Create a resource**.

1. In the **Search the Marketplace** box, type **storage account**, and then press Enter.

1. On the results page, click **Storage account**.

1. On the **Storage account** page, click **Create**.

1. On the **Create storage account** page, specify the following values, and then click **Review + create**.

    [!include[](../../../includes/azure-sandbox-regions-first-mention-note-friendly.md)]

    > [!NOTE]
    > Your storage account must have a unique name. We suggest using something like **\<*your name or initials*\>storage**. Use this name wherever you see *\<your-storage-account-name\>* in this exercise.

    | Property  | Value  |
    |---|---|
    | Subscription | Concierge Subscription  |
    | Resource Group | Use the existing resource group <rgn>[Sandbox resource group]</rgn> |
    | Name | *\<your-storage-account-name\>* |
    | Location | Use the default location |
    | Performance | Standard |
    | Account kind | StorageV2 (general purpose v2) |
    | Replication | Read-access geo-redundant storage (RA-GRS) |
    | Access tier (default) | Hot |

1. On the **Validation passed** page, click **Create**, and wait for the storage account to be deployed.

## View storage metrics in Azure portal

1. In the **Azure portal**, navigate to your storage account.

1. In the menu pane, under **Monitoring**, click select **Metrics**.

1. Examine the properties of the file, table, and queue services. The default configuration should be similar to those for the blob service.

## Configure minute-level metrics using PowerShell

1. In the Azure portal, in the menu pane for your storage account, under **Settings**, click **Access keys**. Make a note of your storage account key (**key1**).

1. Switch to the Azure Cloud Shell window. This window should display a PowerShell prompt.

1. Create an Azure storage context object by running the following command. Specify your storage account name, and account key where indicated:

    ```powershell
    $context = New-AzureStorageContext -StorageAccountName <your-storage-account-name> -StorageAccountKey <your-storage-account-key>
    ```

1. Run the `Set-AzStorageServiceMetricsProperty` command to configure minute-level storage metrics, with a retention period of 7 days:

    ```PowerShell
    Set-AzureStorageServiceMetricsProperty -Context $context -ServiceType Blob -MetricsType Minute -MetricsLevel ServiceAndApi -PassThru -RetentionDays 7
    ```

    Verify that the command completes successfully and generates the following output:

    ```Text
    Version              MetricsLevel                   RetentionDays
    -------              ------------                   -------------
    1.0                  ServiceAndApi                  7
    ```

1. Run the following command to view the metrics configuration for the blob service in your storage account.

    ```powershell
    Get-AzureStorageServiceProperty -Context $context -ServiceType Blob
    ```

    Verify that the output looks similar to the following:

    ```Text
    Logging.Version                     : 1.0
    Logging.LoggingOperations           : None
    Logging.RetentionDays               :
    HourMetrics.Version                 : 1.0
    HourMetrics.MetricsLevel            : ServiceAndApi
    HourMetrics.RetentionDays           : 7
    MinuteMetrics.Version               : 1.0
    MinuteMetrics.MetricsLevel          : ServiceAndApi
    MinuteMetrics.RetentionDays         : 7
    DeleteRetentionPolicy.Enabled       : False
    DeleteRetentionPolicy.RetentionDays :
    StaticWebsite.Enabled               : False
    StaticWebsite.IndexDocument         :
    StaticWebsite.ErrorDocument404Path  :
    Cors                                :
    DefaultServiceVersion               :
    ```

    The important items are the **HourMetrics** and **MinuteMetrics** properties.

1. Return to the Azure portal. On the **Diagnostics settings (classic)** page for your storage account, verify that the **Minute metrics** for the blob storage service are enabled:

    ![Screenshot of the diagnostics settings for the storage account](../media/4-diagnostic-settings.png)

## Upload files to blob storage

1. In the Azure portal, on the page for your storage account, in the menu pane, under **Blob service**, click **Blobs**.

1. In the blobs pane, click **+Container**.

1. Add a container named **testcontainer**, using the **Private (no anonymous access)** access level, and then click **OK**.

1. In the menu pane for your storage account, under **Settings**, click **Access keys**. Make a note of the connection string for **key1**.

1. Return to the PowerShell prompt in Azure Cloud shell.

1. Run the following command to switch to download the sample code for this exercise:

    <!-- NOTE TO REVIEWER. INSERT THE REPO NAME INTO THIS STATEMENT -->
    ```powershell
    git clone https://github.com/<replace with name of repo> storageapps
    ```

1. Move to the **storageapps/StorageTest** folder:

    ```powershell
    cd $HOME/storageapps/StorageTest
    ```

1. Run the sample app that simulates uploading files to blob storage. Replace *\<your connection string\>* with the connection string for your storage account. Ensure that you surround your connection string with double-quotes:

    ```powershell
    dotnet run "<your connection string>" testcontainer
    ```

    As the application runs, you'll see a series of *Uploading blob* messages, followed by an equal number of *Downloading blob** messages.

1. Wait for 1 minute, and then repeat the command.

1. Wait for another minute, and then repeat the command again.

1. Wait for several more minutes before continuing with Part 2 of the exercise.

## *Part 2*

## Visualize metrics using the Azure portal

1. In the Azure portal, navigate to the page for your storage account.

1. In the menu pane, under **Monitoring**, click **Metrics**.

1. In the top right, select **Last Hour** for the time range.

1. Under **Chart Title**, select **Add metric**.

1. Change the **metric namespace** to **Blob**, select **Egress** for **metric**.

1. Under **Chart Title**, select **Add metric**.

1. Change the **metric namespace** to **Blob**, select **Ingress** for **metric**.
    ![Screenshot of the metrics graphs for the storage account](../media/4-metrics-charts.png)

> [!NOTE]
> If your graphs do not display any data, you will need to wait for a few more minutes while Azure Storage Analytics processes the metrics.

## Examine metrics using Azure Storage Explorer

1. On your desktop, download and install [Azure Storage Explorer](https://azure.microsoft.com/features/storage-explorer/)

1. Start Azure Storage Explorer.

1. On the **View** menu, click **Account Management**.

1. In the **SETTINGS** pane, click **Add an account**.

1. In the **Connect to Azure Storage** dialog box, click **Use a connection string**, and then click **Next**.

1. In the **Attach with Connection String** dialog box, set **Display name** to the name of your storage account, enter the connection string for your account that you noted earlier, click **Next**, and then click **Connect**.

1. In the **SETTINGS** pane, click **Apply**.

1. Expand **Local & Attached**, expand **Storage Accounts**, expand your storage account, and then expand **Tables**. You'll see the **\$Metrics** tables.

    ![Screenshot of Storage Explorer displaying the metrics tables](../media/4-metrics-tables.png)

1. Click **\$MetricsMinutePrimaryTransactionsBlob**. This table contains the minute-by-minute summary of the transactions performed in blob storage.

1. In the toolbar, click **Column Options**, and select the following columns:

    - RowKey
    - Timestamp
    - TotalEgress
    - TotalIngress
    - TotalRequests
    - Success
    - AverageE2ELatency
    - AverageServerLatency
    - ServerTimeoutError
    - ThrottlingError
    - NetworkError

    Use the **Move Up** and **Move Down** buttons to arrange the columns in the order shown in the list above, and then click **OK**.

    ![Screenshot of Storage Explorer displaying the minute metrics data for blobs](../media/4-metrics-data.png)

1. Examine the metrics. You should see three sets of **user:All**, **user:GetBlob**, and **user:PutBlob**, corresponding to the requests made for each run of the sample application. You can see how many requests failed (ideally none), the reasons for these failures (if any), and the average latency from end-to-end and at the server. The end-to-end latency includes the time messages spend traversing the network. The average server latency is the time that the storage service spends doing the work for the request.
