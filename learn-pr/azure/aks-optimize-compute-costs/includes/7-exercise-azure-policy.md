As more development teams in your company embrace AKS as a development platform, you realize that you need to manage costs by enforcing business rules that define workload resource limits. You want to make sure that developers can only deploy workloads within specific CPU and memory allocation limits.  The system must prevent workloads that exceed the limits of running.

In this exercise, you'll enable Azure Policy for Azure Kubernetes Service on your AKS cluster. You want to limit the resources requested by workloads deployed by your development teams. To do this, you'll configure a **[Preview]: Ensure container CPU and memory resource limits do not exceed the specified limits in Kubernetes cluster** policy. Finally, you'll test that the policy denies the scheduling of workloads that exceeds the policy's resource parameters.

## Enable the ContainerService and PolicyInsights resource providers

1. Sign in to Azure Cloud Shell with your Azure Account. Select the Bash version of Cloud Shell.

    >[!div class="nextstepaction"]
    >[Azure Cloud Shell](https://shell.azure.com/?azure-portal=true)

    >[!CAUTION]
    >
    >This exercise makes use of preview features. Once you enable some preview features in Azure, defaults may be used for all AKS cluster created in the subscription. Test preview features in non-production subscriptions to avoid unforeseen side effects in production deployments.

1. To use Azure Policy for AKS the configured cluster must be version 1.14. Run the following script to validate your AKS cluster version:

    ```azurecli
    az aks list
    ```

    Make sure that the reported cluster version is >= 1.14

1. Register the Azure Kubernetes Service provider by running the `az provider register` command:

    ```azurecli
    az provider register --namespace Microsoft.ContainerService
    ```

1. Register the Azure Policy provider by running the `az provider register` command:

    ```azurecli
    az provider register --namespace Microsoft.PolicyInsights
    ```

1. Enable the installation of the add-on by running the `az feature register` command:

    ```azurecli
    az feature register --namespace Microsoft.ContainerService --name AKS-AzurePolicyAutoApprove
    ```

1. Check that the registration is successful by querying the feature list table using the `az feature list` command. The feature's registration can take several minutes to complete, and you'll have to check the result periodically.

    ```azurecli
    az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AKS-AzurePolicyAutoApprove')].   {Name:name,State:properties.state}"
    ```

    If the cloud shell session times out, then you can track the registration process via the Azure portal using the [preview onboarding page](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyMenuBlade/JoinPreview/?azure-portal=true).

1. Run the `az provider register` command to propagate the update once you confirmed the feature list query command shows 'Registered'

    ```azurecli
    az provider register -n Microsoft.ContainerService
    ```

## Install the Azure CLI preview extensions

1. To work with this preview, you have to use the `aks-preview` Azure CLI preview extension for AKS. You can ignore the step if you've completed it in the previous exercise.

    Install the latest version of the Azure CLI preview extension by running the `az extension add` command:

    ```azurecli
    az extension add --name aks-preview
    ```

    You can check the installed version of the extension if you've already installed the preview version. Run the `az extension show` command to query the extension version.

    ```azurecli
    az extension show --name aks-preview --query [version]
    ```

    You can update the extension by running the `az extension update` command if you've previously installed the extension and need to update to a newer version.

    ```azurecli
    az extension update --name aks-preview
    ```

## Enable the Azure Policy Add-on

1. Run the `az aks enable-addons` command to enable the `azure-policy` addon for your cluster.

    ```azurecli
    az aks enable-addons \
        --addons azure-policy \
        --name $AKS_CLUSTER_NAME \
        --resource-group $RESOURCE_GROUP
    ```

1. You can verify that the azure-policy pod is installed in the kube-system namespace and gatekeeper pod is installed in the gatekeeper-system namespace by running the following `kubectl get pods` commands:

    ```bash
    kubectl get pods -n kube-system
    ```

    Here is an example of the output result generated by the command:

    ```output
    NAME                                    READY   STATUS    RESTARTS   AGE
    azure-policy-78c8d74cd4-7fqn2           1/1     Running   0          12m
    azure-policy-webhook-545c898766-gsjrc   1/1     Running   0          12m
    ...
    ```

    ```bash
    kubectl get pods -n gatekeeper-system
    ```

    Here is an example of the output result generated by the command:

    ```output
    NAME                                            READY   STATUS    RESTARTS   AGE
    gatekeeper-controller-manager-d5cd87796-5tmhq   1/1     Running   0          15m
    ...
    ```

1. Finally, verify that the latest add-on is installed by running `az aks show` command to retrieve the configuration information for your cluster.

    ```azurecli
    az aks show \
     --resource-group $RESOURCE_GROUP\
     --name $AKS_CLUSTER_NAME \
     -o table --query "addonProfiles.azurepolicy.config.version"
    ```

    ```output
    Result
    --------
    v2
    ```

    You're now ready to switch to the Azure Portal to configure the **[Preview]: Ensure container CPU and memory resource limits do not exceed the specified limits in Kubernetes cluster** policy.

## Assign a built-in policy definition

You configure the new Azure Policy using the Policy service in the Azure portal.

1. Sign in to the [Azure portal](https://portal.azure.com/?azure-portal=true).

1. To locate the *Policy* service in the Azure Portal, enter the term "policy" in the search bar at the top of the portal. **Select** the **Policy** service from the list of services, as shown in the example below.

    :::image type="content" source="../media/7-search-result.png" alt-text="Screenshot of the general Azure portal search box with a result showing for the search term policy.":::

1. The Policy dashboard opens with an overview that shows all your assigned policies and the status of resources and how policies affects them. I've you haven't assigned any policies then the dashboard will be empty.

1. Select the **Assignments** option under the Authoring section from the Policy service's navigation panel.

    :::image type="content" source="../media/7-assignment-option.png" alt-text="Screenshot of the Policy service navigation panel that shows the location of the Assignments option.":::

1. Recall from earlier that you have two options to create a policy assignment. You assign either an initiative or a policy. Select the **Assign policy **option.

    :::image type="content" source="../media/7-assign-policy.png" alt-text="Screenshot that shows the new policy assignment option." lightbox="../media/7-assign-policy.png":::

1. You create a policy by completing sets of information presented in the familiar Azure tab navigation view. The first tab captures basic information.

    | Option | Value |
    | --- | --- |
    | **Scope** | Use the ellipses button top open the **Scope** panel. Select the **subscription** that holds your resource group. Then select the **akscostsavinggrp** resource group. |
    | **Exclusions** | Leave this value empty. |
    | **Policy definition** | Use the ellipses button top open the **Available Definitions** panel. Filter the selection using *CPU* as the term to search in the search box. Select the **[Preview]: Ensure container CPU and memory resource limits do not exceed the specified limits in Kubernetes cluster** policy from the list of options. |
    | **Assignment name** | Leave this value as set by default. |
    | **Description** | Leave this value empty for this exercise. |
    | **Policy enforcement** | Make sure this option is enabled. |
    | **Assigned by** | Leave this value set to the default. |

    Here is an example of the completed **Basics** tab.

    :::image type="content" source="../media/7-complete-basic-tab.png" alt-text="Screenshot that shows the information captured in the basic tab.":::

1. Select the **Parameters** tab to specify the parameters for the policy.

1. Set the following values for each of the parameter options.

    | Option | Value
    | --- | --- |
    | **Max allowed CPU units** | Set the value to **200m**. The policy matches this value to both the workload resource request value as well as the workload limit value as specified in the workload manifest file. |
    | **Max allowed memory bytes** | Set the value to **256Mi**. The policy matches this value to both the workload resource request value and the workload limit value as specified in the workload's manifest file. |
    | **Effect** | Set the value to **deny**. |
    | **Namespace exclusions** | Leave the **default** values as set as *kube-system; gatekeeper-system;azure-arc*. |

    Here is an example of the completed **Parameters** tab.

    :::image type="content" source="../media/7-complete-parameters-tab.png" alt-text="Screenshot that shows the information captured in the basic tab.":::

1. Select the **Remediation** tab. This tab allows you to select how the new policy impacts resources that already exist. By default, only newly created resources are affected by the new policy. Leave the default configuration as is on this tab.

    Here is an example of the completed **Parameters** tab.

    :::image type="content" source="../media/7-complete-remediation-tab.png" alt-text="Screenshot that shows the information captured in the basic tab.":::

1. Select the **Review + save** tab. Review the values selected and click on **Save**.

## Test resource requests

The final step is to test the new policy by deploying a test workload with resource requests and limits set that violates the new policy.

1. Open the Azure Cloud Shell and make sure the Bash version of Cloud Shell is selected.

1. Create a manifest file for the Kubernetes deployment called `test-policy.yaml` by using the integrated editor.

    ```bash
    code test-policy.yaml
    ```

    > [!TIP]
    > Azure Cloud Shell includes an [integrated file editor](https://docs.microsoft.com/azure/cloud-shell/using-cloud-shell-editor). The Cloud Shell editor supports features such as language highlighting, the command palette, and a file explorer. For simple file creation and editing, launch the editor by running `code .` in the Cloud Shell terminal. This action opens the editor with your active working directory set in the terminal. To directly open a file for quick editing, run `code test-policy.yaml` to open the editor without the file explorer.

1. Paste the following text in the file.

    ```yml
    apiVersion: v1
    kind: Pod
    metadata:
        name: nginx
        labels:
            env: test
    spec:
        containers:
            - name: nginx
              image: nginx
              imagePullPolicy: IfNotPresent
              resources:
                requests:
                    cpu: 500m
                    memory: 256Mi
                limits:
                    cpu: 1000m
                    memory: 500Mi
    ```

1. To save the file, select <kbd>Ctrl+S</kbd>. To close the editor, select <kbd>Ctrl+Q</kbd>.

1. Apply the configuration by using the `kubectl apply` command and deploy the application in the `costsavings` namespace.

    ```bash
    kubectl apply \
    --namespace costsavings \
    -f test-policy.yaml
    ```

    You'll see an output like this example.

    ```output
    Error from server (
    [denied by azurepolicy-container-limits-52f2942767eda208f8ac3980dc04b548c4a18a2d1f7b0fd2cd1a7c9e50a92674] container <nginx> memory limit <500Mi> is higher than the maximum allowed of <256Mi>
    [denied by azurepolicy-container-limits-52f2942767eda208f8ac3980dc04b548c4a18a2d1f7b0fd2cd1a7c9e50a92674] container <nginx> cpu limit <1> is higher than the maximum allowed of <200m>)
     : error when creating "test-deploy.yml"
     : admission webhook "validation.gatekeeper.sh" denied the request: 
    [denied by azurepolicy-container-limits-52f2942767eda208f8ac3980dc04b548c4a18a2d1f7b0fd2cd1a7c9e50a92674] container <nginx> memory limit <500Mi> is higher than the maximum allowed of <256Mi>
    [denied by azurepolicy-container-limits-52f2942767eda208f8ac3980dc04b548c4a18a2d1f7b0fd2cd1a7c9e50a92674] container <nginx> cpu limit <1> is higher than the maximum allowed of <200m>
    ```

    Notice how the *admission webhook* `validation.gatekeeper.sh` denied the request to schedule the pod.

1. Open the manifest file and fix the resource request.

    ```bash
    code test-policy.yaml
    ```

    Paste the following text in the file.

    ```yml
    apiVersion: v1
    kind: Pod
    metadata:
        name: nginx
        labels:
            env: test
    spec:
        containers:
            - name: nginx
              image: nginx
              imagePullPolicy: IfNotPresent
              resources:
                requests:
                    cpu: 200m
                    memory: 256Mi
                limits:
                    cpu: 200m
                    memory: 256Mi
    ```

1. To save the file, select <kbd>Ctrl+S</kbd>. To close the editor, select <kbd>Ctrl+Q</kbd>.

1. Apply the configuration by using the `kubectl apply` command and deploy the application in the `costsavings` namespace.

    ```bash
    kubectl apply \
    --namespace costsavings \
    -f test-policy.yaml
    ```

    You'll see an output like this example.

    ```output
    pod/nginx created
    ```

1. You can *watch* the pods rolling out using the `-w` flag with the `kubectl get pods` command. Make sure to query for pods in the `costsavings` namespace.

    ```bash
    kubectl get pods --namespace costsavings
    ```

    In a few seconds, you'll see the pods transition to the `Running` state. Select `CTRL+C` to stop watching.

    ```output
    NAME    READY   STATUS    RESTARTS   AGE
    nginx   1/1     Running   0          50s
    ```
