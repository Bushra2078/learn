After you have improved your Bicep file during the _refactor_ phase, you need to test and deploy your file to your Azure environment. The fourth and fifth phases of the recommended workflow are the _test_ phase and the _deploy_ phase.

:::image type="content" source="../media/6-test-deploy-phases.png" alt-text="Diagram of the test and deploy phases of the recommended workflow for migrating Azure resources to Bicep." border="false":::

The main focus of these two phases is to test your Bicep file using the available tools and deploy your file to your Azure environment.

## Test phase

In the _test_ phase of migrating your resources to Bicep, the goal is to verify the integrity of your migrated templates and to perform a test deployment.

The test phase consists of two steps:, which you complete in sequence

1. Run the ARM template deployment what-if operation.
1. Perform a test deployment.

:::image type="content" source="../media/6-test.png" alt-text="Diagram that shows a Bicep file being tested and deployed to Azure." border="false":::

The what-if operation provides a preview of what changes will be made when you deploy your Bicep file, while a test deployment allows you to compare and contrast your original resources with the newly deployed resources.

### What is the ARM template deployment what-if operation?

When you deploy new resources or modify existing resources, it's possible to introduce breaking changes to your environments. Your deployment could modify or delete existing resources, create incorrectly configured new resources, or impact the overall functionality of your application.

To help you verify your converted templates before deployment, you can use the [Azure Resource Manager template deployment what-if operation](/azure/azure-resource-manager/templates/deploy-what-if?tabs=azure-powershell&azure-portal=true). It compares the current state of your environment with the desired state that is defined in the template. The tool outputs the list of changes that will occur *without* applying the changes to your environment. This process can help increase your confidence level in your deployments. You can use what-if with both incremental and complete mode deployments. Even if you plan to deploy your template using incremental mode, it's a good idea to run your what-if operation in complete mode. This helps you to identify any resources you might have accidentally missed from your template.

> [!NOTE]
> The what-if operation may list some resource properties as deleted, when in reality they won't change. These results are considered _noise_. We work to reduce the noise generated by the what-if command.

### Test deployment

Before introducing your converted Bicep template to production, consider running multiple test deployments. If you have multiple environments (prod, dev, test), you may want to try deploying your template to one of your non-production environments first. After the deployment, compare the original resources with the new resource deployments for consistency.

> [!TIP]
> If you don't have access to a non-production environment to test your deployment, deploy your Bicep template to a new environment instead.

## Deploy phase

In the _deploy_ phase of migrating your resources to Bicep, the goal is to deploy your final Bicep file to production. Prior to the production deployment, there a couple of things to consider.

The deploy phase consists of four steps, which you complete in sequence:

1. Prepare a rollback plan.
1. Run the what-if operation against production.
1. Deploy manually.
1. Run smoke tests.

These steps help prepare for any possible issues you encounter with production deployments.

:::image type="content" source="../media/6-deploy.png" alt-text="Diagram that shows a Bicep file being deployed to Azure." border="false":::

### Prepare a rollback plan

The ability to recover from a failed deployment is crucial. Spend time developing a rollback plan in the event of any breaking changes introduced into your environments. Your plan should take into account your organization's BC/DR strategy. Take inventory of the types of resources that are deployed, such as virtual machines, web apps, and databases. Each resource's data plane should be considered as well. Do you have a way to recover a virtual machine and its data? Do you have a way to recover a database after deletion, or the data from a storage account? A well developed rollback plan will help to keep your downtime to a minimum if any issues arise from a deployment.

### Run the what-if operation against production

You have already run the what-if operation against your other environments to verify that your new Bicep file won't cause any breaking changes. Before deploying your final Bicep file to production, run the what-if operation against your production environment, making sure to use production parameter values, and consider documenting the results.

### Deploy manually

If you're going to use the converted template in a pipeline, such as Azure DevOps or GitHub Actions, consider running the deployment from your local machine first. It is better to verify the functionality of the template before adding it to your production pipeline. That way, you can respond quickly if there's a problem.

### Run smoke tests

After your deployment completes, it is a good idea to run a series of *smoke tests* - simple checks that validate that your application or workload is functioning properly. For example, test to see if your web app is accessible through normal access channels, such as the public Internet or across a corporate VPN. For databases, attempt to make a database connection and execute a series of queries. With virtual machines, log in to the virtual machine and make sure that all services are up and running.
