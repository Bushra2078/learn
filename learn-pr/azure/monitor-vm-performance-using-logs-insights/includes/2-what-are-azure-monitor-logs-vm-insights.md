[Azure Monitor Logs](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-logs) collect and organize log data generated from Azure resources. Log data is stored in a [Log Analytics workspace](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview#what-is-log-analytics). Data living in the workspace can be queried for trend analysis, reporting, and alerting. Some examples of logs captured include Windows event logs, Heartbeat logs, Perf logs, and syslogs.

Azure Monitor Logs are based upon [Azure Data Explorer](https://docs.microsoft.com/azure/data-explorer/data-explorer-overview). A Log Analytics workspace is the equivalent of a database inside the Azure Data Explorer service. For the most part, log data table structure is the same and both resources use the [Kusto Query Language (KQL)](https://docs.microsoft.com/azure/data-explorer/kusto/query/) to extract data.

Virtual Machine Insights (VMInsights) is a set of features, which allow you to monitor VMs in greater detail from within the Azure portal. The solution uses a table named InsightsMetrics. Administrators can query performance and usage for VMs in near real time using that table. The data generated allows you to display everything in a meaningful way. VMInsights also allows administrators an ability to process log data without exposing the underlying queries.

## What is the relationship between all the Azure native monitoring tools?

There are a few different resources and services that complete the native monitoring toolkit in Azure. If we think of the native monitoring story as a pyramid, [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) would live at the top. The service collects and analyzes data generated from Azure resources. Azure Monitor can capture application monitoring data, guest OS monitoring data, Azure resource monitoring data, Azure subscription monitoring data, and Azure tenant monitoring data.

Data collected by Azure Monitor is composed of metrics ([Azure Monitor Metrics](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-metrics)) and logs ([Azure Monitor Logs](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-logs)). Azure Monitor Metrics are lightweight numerical values stored in a time-series database that can be used for near real time (NRT) alerting. Some examples of metrics captured include IOPS percentages and CPU cycles. As we covered earlier, Azure Monitor Logs collects and organizes log data from Azure resources. The major difference between Azure Monitor Metrics and Azure Monitor Logs surrounds the structure of data generated. Azure Monitor Metrics can only store numeric data using a specific structure, while Azure Monitor Logs can store a variety of data types, each using their own structure. Azure Monitor Logs can also store Azure Monitor Metric data as well.

The following image shows how applications, resources, workloads, tenant data, and custom sources funnel into Azure Monitor (either metrics or logs). Once the data lives in metrics or logs, there are a number of different ways to visualize, analyze, respond, integrate, and view overall resource health.
![Azure Monitor Diagram](https://docs.microsoft.com/azure/azure-monitor/media/overview/overview.png)

## But wait, there's **MORE** logging

In addition to logs and metrics, Azure resources also emit [Azure platform logs](https://docs.microsoft.com/azure/azure-monitor/platform/platform-logs-overview) as well. Platform logs provide comprehensive diagnostic and auditing information for Azure resources and the underlying Azure platform. Platform logs are [resource logs](https://docs.microsoft.com/azure/azure-monitor/platform/resource-logs) (formerly known as diagnostic logs), [activity logs](https://docs.microsoft.com/azure/azure-monitor/platform/activity-log), and [Azure Active Directory logs](https://docs.microsoft.com/azure/active-directory/reports-monitoring/overview-reports). As of September of 2018, all resources automatically generate platform logs and send data to Azure Monitor. Administrators need to configure certain platform logs to be forwarded to one or more destinations (like Log Analytics) to be retained.

## Plan a Log Analytics workspace deployment

One of the tasks involved with a Log Analytics deployment is picking the right design. Log Analytics workspaces are containers where Azure Monitor data is collected, aggregated, and analyzed. To better understand Log Analytics workspaces, the following diagram provides more insight into all the different types of logs that can be ingested. Everything from Event logs, to Syslogs, to Heartbeats, and so on. Then there are Azure Resources that can send platform logs and Azure Activity logs to the workspace as well.

![Log Analytics Diagram](https://docs.microsoft.com/azure/azure-monitor/platform/media/design-logs-deployment/logs-data-model-01.png)

As of March 2019, a number of Azure features were introduced to help Log Analytics workspace adoption within enterprises. Log Analytics workspaces now provide different levels of access control for the collected logs.

| Feature | Description | Notes
| ---- | ---- | ---- |
| [Access mode](https://docs.microsoft.com/azure/azure-monitor/platform/design-logs-deployment#access-mode) | Involves how users access a Log Analytics workspace, plus defines data scope | Two options: 1) workspace-context - provides access to all logs in a workspace where the permission is assigned. Queries are scoped to all data in all tables. 2) resource-context - provides access to view logs for resources in all tables you have access to. Queries are scoped to only data associated with that resource.
[Access control mode](https://docs.microsoft.com/azure/azure-monitor/platform/design-logs-deployment#access-control-mode) | Defines how permissions work for any given Log Analytics workspace. | Require workspace permissions means a user would have access to all data in any table where permissions have been defined, which does not allow granular role-based access control (RBAC). Then there's the use resource or workspace permissions, which allows for granular RBAC as users can only see log data for resources they are permitted to view. Permissions can be applied to an individual or to groups of users for the workspace or resource.
| [Table level RBAC](https://docs.microsoft.com/azure/azure-monitor/platform/manage-access#table-level-rbac) | Provides a mechanism to define more granular data control inside a Log Analytics workspace in conjunction with other permissions listed in the table. | This feature allows an administrator to define what specific data types are accessible to a set of users. Configuring table level RBAC requires [Azure custom roles](https://docs.microsoft.com/azure/role-based-access-control/custom-roles) to either grant or deny access to specific tables. These roles are applied to Log Analytics workspaces, with either workspace-context or resource-context access modes configured.

From a daily operations point of view, the best strategy is to limit the total number of workspaces required for daily operations. Reducing the number of workspaces will make administration and query experience easier and quicker. Multiple workspaces may be a design consideration if you are employed by a global company and require data sovereignty, for example.

## Connecting the dots

Compute resources in Azure require a number of [agents](https://docs.microsoft.com/azure/azure-monitor/platform/agents-overview) to help collect monitoring data inside Log Analytics and Azure Monitor. Each agent allows customers to measure performance, responsiveness, and availability of guest operating systems and underlying workloads.

The following table lists each agent

| Agent | Description | Notes
| ---- | ---- | ---- |
| [Log Analytics agent](https://docs.microsoft.com/azure/azure-monitor/platform/agents-overview#log-analytics-agent) | Collects logs and performance data for VMs in Azure, other clouds, or on-premises. | Allows the onboarding of [Azure Security Center](https://docs.microsoft.com/azure/security-center/security-center-intro) and [Azure Sentinel](https://docs.microsoft.com/azure/sentinel/overview). The agent also works in conjunction with [Azure Automation](https://docs.microsoft.com/azure/automation/automation-intro) accounts to onboard solutions like [Azure Update Management](https://docs.microsoft.com/azure/automation/update-management/update-mgmt-overview), [Azure Automation State Configuration](https://docs.microsoft.com/azure/automation/automation-dsc-overview), along with [Azure Automation Change Tracking and Inventory](https://docs.microsoft.com/azure/automation/change-tracking).
| [Azure diagnostics extension](https://docs.microsoft.com/azure/azure-monitor/platform/agents-overview#azure-diagnostics-extension) | Enables customers to receive additional data from guest operating systems and workloads living on compute resources. | This data can be sent to a third-party tool by using [Azure Event Hubs](https://docs.microsoft.com//azure/azure-monitor/platform/diagnostics-extension-stream-event-hubs), sent to [Azure Storage](https://docs.microsoft.com/azure/storage/common/storage-introduction) for archival, sent to [Azure Monitor Metrics](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-metrics), or collect [boot diagnostics](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/boot-diagnostics) that help with investigation for VM boot issues.
| [Dependency agent](https://docs.microsoft.com/azure/azure-monitor/platform/agents-overview#dependency-agent) | Collects discovered data about certain processes running on virtual machines. | Maps all dependencies between VMs and any external process dependencies.

As referenced earlier, [Virtual Machine Insights](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-ga-release-faq#updates-for-azure-monitor-for-vms) also needs to be installed in order for a given Log Analytics workspace to be used with Azure Monitor VM log data. As of January 2020, Virtual Machine Insights is a new service that provides additional visibility and capabilities for data collection of VMs.

Lastly, there are a number of [solutions](https://docs.microsoft.com/azure/azure-monitor/monitor-reference#insights-and-core-solutions) an administrator can install or enable, which provides deeper analytics on any given Azure application or service. Each monitoring solution requires a Log Analytics workspace to store collected data. Some solutions also require an Automation Account as well, which contain resources like runbooks that help complete the solution.