The information below describes the identity attestation process when using a Trusted Platform Module (TPM), which is a type of hardware security module (HSM). It is not for devices using X.509 certificates for authentication.

> [!NOTE]
> This information is only relevant for devices using TPM 2.0 with HMAC key support and their endorsement keys and assumes you are using a discrete, firmware, or integrated TPM. Software emulated TPMs are well suited for prototyping or testing, but they do not provide the same level of security as discrete, firmware, or integrated TPMs do. We do not recommend using software TPMs in production.

## Overview

Trusted Platform Module (TPM) attestation uses something called the endorsement key (EK) as the secure root of trust. The EK is unique to the TPM and changing it essentially changes the device into a new one.

There's another type of key that TPMs have, called the storage root key (SRK). An SRK may be generated by the TPM's owner after it takes ownership of the TPM. Taking ownership of the TPM is the TPM-specific way of saying "someone sets a password on the HSM." If a TPM device is sold to a new owner, the new owner can take ownership of the TPM to generate a new SRK. The new SRK generation ensures the previous owner can't use the TPM. Because the SRK is unique to the owner of the TPM, the SRK can be used to seal data into the TPM itself for that owner. The SRK provides a sandbox for the owner to store their keys and provides access revocability if the device or TPM is sold. It's like moving into a new house: taking ownership is changing the locks on the doors and removing the furniture left by the previous owners (SRK), but you can't change the address of the house (EK).

Once a device has been set up and ready to use, it will have both an EK and an SRK available for use.

:::image type="content" source="../media/m03-l01-device-provisioning-service-trusted-platform-module-ownership-2e2f42a8.png" alt-text="Diagram that shows an overview of Trusted Platform Module attestation using endorsement keys.":::


One note on taking ownership of the TPM: Taking ownership of a TPM depends on many things, including TPM manufacturer, the set of TPM tools being used, and the device OS. Follow the instructions relevant to your system to take ownership.

The Device Provisioning Service uses the public part of the EK (EK\_pub) to identify and enroll devices. The device vendor can read the EK\_pub during manufacture or final testing and upload the EK\_pub to the provisioning service so that the device will be recognized when it connects to provision. The Device Provisioning Service does not check the SRK or owner, so "clearing" the TPM erases customer data, but the EK (and other vendor data) is preserved and the device will still be recognized by the Device Provisioning Service when it connects to provision.

## Detailed attestation process

When a device with a TPM first connects to the Device Provisioning Service, the service first checks the provided EK\_pub against the EK\_pub stored in the enrollment list. If the EK\_pubs do not match, the device is not allowed to provision. If the EK\_pubs do match, the service then requires the device to prove ownership of the private portion of the EK via a nonce challenge, which is a secure challenge used to prove identity. The Device Provisioning Service generates a nonce and then encrypts it with the SRK and then the EK\_pub, both of which are provided by the device during the initial registration call. The TPM always keeps the private portion of the EK secure. This prevents counterfeiting and ensures SAS tokens are securely provisioned to authorized devices.

Let's walk through the attestation process in detail.

### Device requests an IoT Hub assignment

First the device connects to the Device Provisioning Service and requests to provision. In doing so, the device provides the service with its registration ID, an ID scope, and the EK\_pub and SRK\_pub from the TPM. The service passes the encrypted nonce back to the device and asks the device to decrypt the nonce and use that to sign a SAS token to connect again and finish provisioning.

:::image type="content" source="../media/m03-l01-device-provisioning-service-trusted-platform-module-attestation-step-one-request-provisioning-7c429419.png" alt-text="Diagram that shows TPM attestation step 1, the device makes a provisioning request.":::


### Nonce challenge

The device takes the nonce and uses the private portions of the EK and SRK to decrypt the nonce into the TPM; the order of nonce encryption delegates trust from the EK, which is immutable, to the SRK, which can change if a new owner takes ownership of the TPM.

:::image type="content" source="../media/m03-l01-device-provisioning-service-trusted-platform-module-attestation-step-two-nonce-challenge-6cb6fdc5.png" alt-text="Diagram that shows TPM attestation step 2, device completes the nonce challenge.":::


### Validate the nonce and receive credentials

The device can then sign a SAS token using the decrypted nonce and reestablish a connection to the Device Provisioning Service using the signed SAS token. With the Nonce challenge completed, the service allows the device to provision.

:::image type="content" source="../media/m03-l01-device-provisioning-service-trusted-platform-module-attestation-step-three-validation-922a60fc.png" alt-text="Diagram that shows TPM attestation step 3, the nonce is validated and the device receives IoT hub connection information.":::


Now the device connects to IoT Hub, and you rest secure in the knowledge that your devices' keys are securely stored.
