## What are automation rules and playbooks?

Automation rules help you triage incidents in Microsoft Sentinel. You can use them to automatically assign incidents to the right personnel, close noisy incidents or known false positives, change their severity, and add tags. They are also the mechanism by which you can run playbooks in response to incidents or alerts.

Playbooks are collections of procedures that can be run from Microsoft Sentinel in response to an **entire incident**, to an **individual alert,** or to a **specific entity**. A playbook can help automate and orchestrate your response, and can be set to run automatically when specific alerts are generated or when incidents are created or updated, by being attached to an automation rule. It can also be run manually on-demand on specific incidents, alerts, or entities.<br>

Playbooks in Microsoft Sentinel are based on workflows built in Azure Logic Apps, which means that you get all the power, customizability, and built-in templates of Logic Apps. Each playbook is created for the specific subscription to which it belongs, but the **Playbooks** display shows you all the playbooks available across any selected subscriptions.

For example, if you want to stop potentially compromised users from moving around your network and stealing information, you can create an automated, multifaceted response to incidents generated by rules that detect compromised users. You start by creating a playbook that takes the following actions:

1.  When the playbook is called by an automation rule passing it an incident, the playbook opens a ticket in ServiceNow or any other IT ticketing system.
2.  It sends a message to your security operations channel in Microsoft Teams or Slack to make sure your security analysts are aware of the incident.
3.  It also sends all the information in the incident in an email message to your senior network admin and security admin. The email message will include **Block** and **Ignore** user option buttons.
4.  The playbook waits until a response is received from the admins, then continues with its next steps.
5.  If the admins choose **Block**, it sends a command to Microsoft Entra ID to disable the user, and one to the firewall to block the IP address.
6.  If the admins choose **Ignore**, the playbook closes the incident in Microsoft Sentinel, and the ticket in ServiceNow.
7.  In order to trigger the playbook, you'll then create an automation rule that runs when these incidents are generated. That rule will take these steps:
     -  The rule changes the incident status to Active.
     -  It assigns the incident to the analyst tasked with managing this type of incident.
     -  It adds the "compromised user" tag.
     -  Finally, it calls the playbook you just created. (Special permissions are required for this step.)

Playbooks can be run automatically in response to incidents, by creating automation rules that call the playbooks as actions, as in the example above. They can also be run automatically in response to alerts, by telling the analytics rule to automatically run one or more playbooks when the alert is generated.

You can also choose to run a playbook manually on-demand, as a response to a selected alert.

Get a more complete and detailed introduction to automating threat response using automation rules and playbooks in Microsoft Sentinel.

## Create a playbook

Follow these steps to create a new playbook in Microsoft Sentinel

:::image type="content" source="../media/new-add-new-playbook-7ca92f3d.png" alt-text="Sceenshot showing steps to create a new playbook in Microsoft Sentinel.":::


1.  From the **Microsoft Sentinel** navigation menu, select **Automation**.
2.  From the top menu, select **Create**.
3.  The drop-down menu that appears under **Create** gives you four choices for creating playbooks:
     -  If you're creating a **Standard** playbook (the new kind - see Logic app types), select **Blank playbook** and then follow the steps in the Logic Apps Standard tab below.
     -  If you're creating a **Consumption** playbook (the original, classic kind), then depending on which trigger you want to use, select either **Playbook with incident trigger**, **Playbook with alert trigger**, or **Playbook with entity trigger**. Then, continue following the steps in the **Logic Apps Consumption** tab below.
4.  In the **Basics** tab:
     -  Select the **Subscription**, **Resource group**, and Region of your choosing from their respective drop-down lists. The chosen region is where your Logic App information will be stored.
     -  Enter a name for your playbook under **Playbook name**.
     -  If you want to monitor this playbook's activity for diagnostic purposes, mark the **EnablediagnosticslogsinLog Analytics** check box, and choose your Log **Analytics workspace** from the drop-down list.
     -  If your playbooks need access to protected resources that are inside or connected to an Azure virtual network, you may need to use an integration service environment (ISE). If so, mark the **Associate with integration service environment** check box, and select the desired ISE from the drop-down list.
     -  Select **Next :Connections**.
5.  In the **Connections** tab:
     -  Ideally you should leave this section as is, configuring Logic Apps to connect to Microsoft Sentinel with managed identity. Learn about this and other authentication alternatives.
6.  Select **Next : Review and create**.
7.  In the **Review and create** tab:
     -  Incidents can have two possible sources: they can be created inside Microsoft Sentinel, and they can also be imported from and synchronized with Microsoft 365 Defender.
         -  If you selected one of the incident triggers and you want the automation rule to take effect only on incidents sourced in Microsoft Sentinel, or alternatively in Microsoft 365 Defender, specify the source in the **If Incident provider equals** condition. (This condition will be displayed only if an incident trigger is selected.)
     -  For all trigger types, if you want the automation rule to take effect only on certain analytics rules, specify which ones by modifying the **If Analytics rule name contains** condition.
     -  Add any other conditions you want to determine whether this automation rule will run. Select + Add and choose conditions or condition groups from the drop-down list. The list of conditions is populated by alert detail and entity identifier fields.
     -  Since you're using this automation rule to run a playbook, choose the Run playbook action from the drop-down list. You'll then be prompted to choose from a second drop-down list that shows the available playbooks. An automation rule can run only those playbooks that start with the same trigger (incident or alert) as the trigger defined in the rule, so only those playbooks will appear in the list.
     -  You yourself must have **owner** permissions on any resource group to which you want to grant Microsoft Sentinel permissions, and you must have the Logic App Contributor role on any resource group containing playbooks you want to run.
     -  In a multitenant deployment, if the playbook you want to run is in a different tenant, you must grant Microsoft Sentinel permission to run the playbook in the playbook's tenant.
         -  From the Microsoft Sentinel navigation menu in the playbooks' tenant, select **Settings**.
         -  In the **Settings** blade, select the **Settings** tab, then the **Playbook permissions** expander.
         -  Click the Configure permissions button to open the **Manage permissions** panel mentioned above, and continue as described there.
     -  If, in an **MSSP** scenario, you want to **run a playbook in a customer tenant** from an automation rule created while signed into the service provider tenant, you must grant Microsoft Sentinel permission to run the playbook in ***both tenants***. In the **customer** tenant, follow the instructions for the multitenant deployment in the preceding bullet point. In the **service provider** tenant, you must add the **Azure Security Insights** app in your Azure Lighthouse onboarding template:
         -  From the Azure portal go to **Microsoft Entra ID**.
         -  Click on **Enterprise Applications**.
         -  Select **Application Type** and filter on **Microsoft Applications**.
         -  In the search box type **Azure Security Insights**.
         -  Copy the **Object ID** field. You will need to add this additional authorization to your existing Azure Lighthouse delegation.
     -  The **Microsoft Sentinel Automation Contributor** role has a fixed GUID which is **`f4c81013-99ee-4d62-a7ee-b3f1f648599a.`**
     -  Add any other actions you want for this rule. You can change the order of execution of actions by selecting the up or down arrows to the right of any action.<br>
8.  Review the configuration choices you have made, and select **Create and continue to designer**.

    > [!IMPORTANT]
    > **Microsoft Sentinel must be granted explicit permissions in order to run playbooks**, whether manually or from automation rules. If a playbook appears "grayed out" in the drop-down list, it means Sentinel does not have permission to that playbook's resource group. Click the **Manage playbook permissions** link to assign permissions.
