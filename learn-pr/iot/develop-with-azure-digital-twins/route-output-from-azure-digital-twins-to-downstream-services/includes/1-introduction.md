:::image type="content" source="../media/azure-digital-twins-time-series-insights-flow.png" alt-text="Diagram that illustrates the flow of data from Azure Digital Twins to Time Series Insights.":::

In an Azure Digital Twins solution, you can route event notifications to downstream services or connected compute resources. You configure this routing by first setting up *endpoints* that can receive the events. You can then create *event routes* that specify which events generated by Azure Digital Twins are delivered to which endpoints.

There are many services to which you might ultimately want to direct your data, like [Azure Storage](https://docs.microsoft.com/azure/storage/common/storage-introduction), [Azure Maps](https://docs.microsoft.com/azure/azure-maps/about-azure-maps), and [Azure Time Series Insights](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-update-overview). To send your data to services like these, you first need to attach the destination service to an endpoint.

## How do event routes work?

You attach endpoints to Azure Digital Twins by using management APIs or the Azure portal. For more information on how to attach an endpoint to Azure Digital Twins, see the [guide for managing endpoints and routes](https://docs.microsoft.com/azure/digital-twins/how-to-manage-routes-apis-cli).

- Event routes use [Azure Event Hubs](https://docs.microsoft.com/azure/event-hubs/event-hubs-about), [Azure Event Grid](https://docs.microsoft.com/azure/event-grid/overview), or [Azure Service Bus](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview) to drive your data flows.
- All events entering or generated by Azure Digital Twins flow into a common event stream.
- Developers can define routes to pick a subset of data items of the event stream and send them to endpoints.

In this module, you'll learn how to route events to Time Series Insights to query and visualize events received from Azure Digital Twins.

## What is Azure Time Series Insights?

[Azure Time Series Insights](https://azure.microsoft.com/services/time-series-insights/) is an analytics platform for monitoring, analyzing, and visualizing your industrial IoT data at scale. It also enables simple windowed compute in operational contexts to answer root cause analysis questions when operators and developers need more than last-known values. It uses real-time or near real-time insights from analytics to achieve operational optimization and excellence. For more information on Time Series Insights, see these resources:

- [Time Series Insights documentation](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-overview)
- [Learn module: Explore and analyze time-stamped data with Time Series Insights](https://docs.microsoft.com/learn/modules/explore-analyze-time-series-insights/)

## Azure Digital Twins events

In many cases, you need to send data from Azure Digital Twins to downstream services for further analysis, integration, simulation, or processing. In this module, you'll explore how to send data to a Time Series Insights instance to record time series data of manufacturing-process events for bulk analytics.

You handle data egress by using event routes. An event route lets you send event data (like telemetry events, lifecycle events, and property-change events) from twins to defined endpoints in your subscriptions (like an event hub, event grid, or service bus).

Azure Digital Twins will emit the following events (notifications and telemetry messages). They'll be routed to custom endpoints.


| Notification type                    | Routing source name   | Generated from...  |
|--------------------------------------|-----------------------|--------------------|
| Digital Twin Change Notification     | Digital Twin Change Notification | Any digital twin property change |
| Digital Twin Lifecycle Notification  | Digital Twin Lifecycle Notification | Any digital twin create or delete operation |
| Digital Twin Relationship Change Notification  | Digital Twin Relationship Change Notification  | Any digital twin relationship change |
| Digital Twin Telemetry Messages      | Telemetry Messages        | Any telemetry message |

For more information about the notification types in this table, see [the Azure Digital Twins event data article](https://docs.microsoft.com/azure/digital-twins/how-to-interpret-event-data).

## Endpoints

To define an event route, developers first must define endpoints. An endpoint is a connection to a destination outside of Azure Digital Twins. Supported destinations are as follows:

- Event Grid
- Event Hubs
- Service Bus

:::image type="content" source="../media/event-data-flow.png" alt-text="Diagram that illustrates the flow of event data through a large IoT solution.":::

**The flow of event data through a large IoT solution (a railway monitoring system).**

## Routes

You define event routes by using data plane APIs. A route definition contains:

- The route ID.
- The endpoint ID.
- A filter that defines which events are sent to the endpoint.

Here are some use cases for routes:

- Store Azure Digital Twins data in [Azure Data Lake](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-introduction).
- Analyze Azure Digital Twins data with [Azure Synapse Analytics](https://docs.microsoft.com/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-overview-what-is) or other Microsoft data analytics tools.
- Integrate larger workflows with Azure Logic Apps.
- Connect Azure Digital Twins to Time Series Insights to track the time series history of each twin.
- Align a time series model in Time Series Insights with a source in Azure Digital Twins.
- Route events to compute services like Azure Functions for advanced simulation or data processing.

## Learning objectives

In this module, you will:

- Build and simulate the chocolate factory twin.
- Create a route and filter for twin update notifications.
- Create and configure an Azure function and send telemetry to an event hub.
- Create a Time Series Insights instance and connect it to Azure Digital Twins.
- Visualize and query your data in Time Series Insights.

## Prerequisites

- (Recommended.) Introductory knowledge of Azure IoT. You can learn more by completing the [Introduction to Azure IoT](https://docs.microsoft.com/en-us/learn/paths/introduction-to-azure-iot/) learning path.
- A basic understanding of the Azure CLI. We recommend that you complete the [Control Azure services with the CLI](https://docs.microsoft.com/en-us/learn/modules/control-azure-services-with-cli/)â€¯module. 
- [The Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli).
  - We recommend that you install Azure CLI locally. 
  - We don't recommend that you use Azure Cloud Shell. It will time out because of the length of the lab.
- PowerShell. 
  - On Windows, PowerShell is built in.
  - On macOS, you need to install [PowerShell for Mac](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-macos?view=powershell-6).
- (For the exercise units.) Access to an Azure subscription in which you have the Global Administrator role for your account and an Azure Active Directory tenant.
- (Recommended.) Some experience working with Time Series Insights. You can learn more by completing the [Explore and analyze time-stamped data with Time Series Insights](https://docs.microsoft.com/en-us/learn/modules/explore-analyze-time-series-insights/) module.
- [Node.js](https://nodejs.org/en/download/) to run the device simulator application.  
- [Git](https://git-scm.com/downloads).
- [Visual Studio Code](https://code.visualstudio.com/).
- [.NET Core 3.1](https://dotnet.microsoft.com/download).
- [C# Visual Studio Code extension](https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp).
- [Azure Functions Visual Studio Code extension](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions).
